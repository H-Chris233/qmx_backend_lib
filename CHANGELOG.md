# å˜æ›´æ—¥å¿—

æ‰€æœ‰é‡è¦çš„é¡¹ç›®å˜æ›´éƒ½ä¼šè®°å½•åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚

æ ¼å¼åŸºäº [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)ï¼Œ
é¡¹ç›®éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/lang/zh-CN/)ã€‚

## [2.2.0] - 2025-09-15

### ğŸš¨ ç ´åæ€§å˜æ›´

#### CashBuilder API å˜æ›´
- **BREAKING**: `CashBuilder::build()` ç°åœ¨è¿”å› `Result<Cash>` è€Œä¸æ˜¯ `Cash`
- **BREAKING**: é‡‘é¢ä¸º 0 æ—¶ä¼šè¿”å›é”™è¯¯: `"amount cannot be zero"`
- **BREAKING**: `CashUpdater::amount()` ç°åœ¨ä¼šåœ¨è¿è¡Œæ—¶æ ¡éªŒé‡‘é¢ä¸èƒ½ä¸º0

```rust
// è¿ç§»ç¤ºä¾‹
// æ—§ä»£ç  (v2.1.x)
let cash = CashBuilder::new(amount).build();

// æ–°ä»£ç  (v2.2.0+)
let cash = CashBuilder::new(amount).build()?;  // éœ€è¦é”™è¯¯å¤„ç†
```

#### TimePeriod è¡Œä¸ºå˜æ›´
- **BREAKING**: `FinancialStats::calculate()` ç°åœ¨çœŸæ­£æŒ‰ `TimePeriod` è¿‡æ»¤æ•°æ®
- ä¹‹å‰ `TimePeriod` å‚æ•°è¢«å¿½ç•¥ï¼Œæ€»æ˜¯è¿”å›å…¨éƒ¨æ—¶é—´çš„ç»Ÿè®¡
- ç°åœ¨å„æ—¶é—´å‘¨æœŸä¼šå®é™…è¿‡æ»¤å¯¹åº”æ—¶é—´èŒƒå›´çš„æ•°æ®

```rust
// å¦‚æœéœ€è¦å…¨éƒ¨æ—¶é—´çš„ç»Ÿè®¡ï¼Œå¿…é¡»æ˜¾å¼æŒ‡å®š
let all_stats = manager.get_financial_stats(TimePeriod::AllTime)?;
```

### âœ¨ æ–°å¢åŠŸèƒ½

#### å­—æ®µæ¸…ç©ºæ”¯æŒ
- `StudentUpdater` ç°åœ¨æ”¯æŒç”¨ `None` æ˜¾å¼æ¸…ç©º Optional å­—æ®µ
- æ”¯æŒæ¸…ç©º `lesson_left` å’Œ `membership` å­—æ®µ

```rust
// æ¸…ç©ºè¯¾æ—¶å’Œä¼šå‘˜ä¿¡æ¯
manager.update_student(uid, 
    StudentUpdater::new()
        .lesson_left(None)        // æ¸…ç©ºè¯¾æ—¶å­—æ®µ
        .membership(None, None)   // æ¸…ç©ºä¼šå‘˜ä¿¡æ¯
)?;
```

#### TimePeriod å¢å¼º
- æ–°å¢ `TimePeriod::Today` - ä»Šæ—¥ç»Ÿè®¡
- æ–°å¢ `TimePeriod::Custom { start, end }` - è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ç»Ÿè®¡

```rust
let today_stats = manager.get_financial_stats(TimePeriod::Today)?;
let custom_stats = manager.get_financial_stats(TimePeriod::Custom {
    start: start_date,
    end: end_date,
})?;
```

#### ç¯å¢ƒå˜é‡é…ç½®
- æ–°å¢ `QMX_DATA_DIR` ç¯å¢ƒå˜é‡æ”¯æŒ
- å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æ•°æ®ç›®å½•è·¯å¾„

```rust
std::env::set_var("QMX_DATA_DIR", "/custom/data/path");
let manager = QmxManager::new(true)?;  // ä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„
```

#### Student API å¢å¼º
- æ–°å¢ `Student::set_class_with_lesson_init()` æ–¹æ³•
- åˆ†ç¦»äº† `set_class()` çš„å‰¯ä½œç”¨ï¼Œæä¾›æ›´æ¸…æ™°çš„APIè®¾è®¡
- æ–°å¢ `StudentUpdater::clear_lesson_left()` ä¾¿æ·æ–¹æ³•

### ğŸ”§ æ”¹è¿›

#### é”™è¯¯å¤„ç†ä¼˜åŒ–
- ç§»é™¤äº† JSON æ ¼å¼çš„é”™è¯¯åµŒå…¥ï¼Œæ”¹ç”¨æ ‡å‡†æ—¥å¿—è®°å½•
- `Database::save_to_string()` å¤±è´¥æ—¶è¿”å›ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯JSONé”™è¯¯
- å¢å¼ºäº†é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯

#### æ€§èƒ½ä¼˜åŒ–
- **å»¶è¿Ÿå…‹éš†**: æŸ¥è¯¢æ¥å£å»¶è¿Ÿå…‹éš†æ“ä½œåˆ°APIè¾¹ç•Œ
- å‡å°‘äº†ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- ä¼˜åŒ–äº† `StudentQuery` å’Œ `CashQuery` çš„å†…å­˜ä½¿ç”¨

#### æ•°æ®ä¸€è‡´æ€§å¢å¼º
- ä½¿ç”¨ `tempfile` crate æ›¿æ¢æ‰‹å†™çš„åŸå­å†™å…¥æ“ä½œ
- å¢åŠ  `fsync` å’Œç›®å½•åŒæ­¥æ”¯æŒï¼Œæå‡å´©æºƒä¸€è‡´æ€§
- UID è®¡æ•°å™¨å†™å…¥ç°åœ¨åŒ…å«å®Œæ•´çš„æŒä¹…åŒ–ä¿è¯

#### ä»£ç è´¨é‡
- ç»Ÿä¸€äº†é”™è¯¯å¤„ç†æ¨¡å¼ï¼Œä½¿ç”¨ `anyhow::Context`
- æ”¹è¿›äº†æ¨¡å—é—´çš„èŒè´£åˆ†ç¦»
- å¢å¼ºäº†è¾“å…¥éªŒè¯å’Œç±»å‹å®‰å…¨

### ğŸ› ä¿®å¤

#### åŠŸèƒ½ä¿®å¤
- ä¿®å¤äº† `TimePeriod` åœ¨è´¢åŠ¡ç»Ÿè®¡ä¸­è¢«å¿½ç•¥çš„é—®é¢˜
- ä¿®å¤äº† `StudentUpdater` æ— æ³•æ¸…ç©º Optional å­—æ®µçš„é—®é¢˜
- ä¿®å¤äº†åŸå­å†™å…¥åœ¨æŸäº›å¹³å°ä¸Šçš„å…¼å®¹æ€§é—®é¢˜

#### æµ‹è¯•ä¿®å¤
- æ›´æ–°äº†æ‰€æœ‰å—APIå˜æ›´å½±å“çš„æµ‹è¯•ç”¨ä¾‹
- ä¿®å¤äº† `test_student_set_class_with_lesson_init` æµ‹è¯•
- ç¡®ä¿æµ‹è¯•è¦†ç›–æ–°çš„é”™è¯¯å¤„ç†è·¯å¾„

### ğŸ“š æ–‡æ¡£æ›´æ–°

- æ›´æ–°äº† `API_v2.md` ä»¥åæ˜ æ‰€æœ‰APIå˜æ›´
- åˆ›å»ºäº† `API_CHANGES_v2.2.0.md` è¯¦ç»†è¿ç§»æŒ‡å—
- å¢åŠ äº†ç ´åæ€§å˜æ›´çš„è¯¦ç»†è¯´æ˜å’Œè¿ç§»ç¤ºä¾‹
- æ›´æ–°äº†æ‰€æœ‰ä»£ç ç¤ºä¾‹ä»¥ä½¿ç”¨æ–°çš„API

### ğŸ”’ å®‰å…¨æ€§

- å¢å¼ºäº†æ–‡ä»¶å†™å…¥çš„åŸå­æ€§ï¼Œé˜²æ­¢æ•°æ®æŸå
- æ”¹è¿›äº†é”™è¯¯ä¿¡æ¯çš„å¤„ç†ï¼Œé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²
- åŠ å¼ºäº†è¾“å…¥éªŒè¯ï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®å†™å…¥

---

## [2.1.0] - 2025-09-14

### âœ¨ æ–°å¢åŠŸèƒ½
- å®Œæ•´çš„ v2 API å®ç°
- ç»Ÿä¸€çš„ `QmxManager` å…¥å£
- Builderã€Updaterã€Query æ¨¡å¼æ”¯æŒ
- çº¿ç¨‹å®‰å…¨çš„è®¾è®¡æ¶æ„

### ğŸ”§ æ”¹è¿›
- å‘åå…¼å®¹ v1 API
- å¢å¼ºçš„ç»Ÿè®¡åˆ†æåŠŸèƒ½
- æ”¹è¿›çš„é”™è¯¯å¤„ç†

---

## [2.0.0] - 2025-09-13

### ğŸš¨ ç ´åæ€§å˜æ›´
- å¼•å…¥å…¨æ–°çš„ v2 API æ¶æ„
- é‡æ„äº†æ ¸å¿ƒæ•°æ®ç»“æ„

### âœ¨ æ–°å¢åŠŸèƒ½
- ç°ä»£åŒ–çš„ API è®¾è®¡
- æ”¹è¿›çš„ç±»å‹å®‰å…¨
- å¢å¼ºçš„æŸ¥è¯¢èƒ½åŠ›

---

## [1.0.0] - 2025-09-12

### âœ¨ åˆå§‹å‘å¸ƒ
- åŸºç¡€çš„å­¦ç”Ÿç®¡ç†åŠŸèƒ½
- ç°é‡‘è®°å½•ç³»ç»Ÿ
- ç®€å•çš„ç»Ÿè®¡åˆ†æ
- JSON æ•°æ®æŒä¹…åŒ–

---

## è¿ç§»æŒ‡å—

### ä» v2.1.x å‡çº§åˆ° v2.2.0

1. **æ›´æ–° CashBuilder è°ƒç”¨**:
   ```rust
   // æ—§ä»£ç 
   let cash = CashBuilder::new(amount).build();
   
   // æ–°ä»£ç 
   let cash = CashBuilder::new(amount).build()?;
   ```

2. **æ£€æŸ¥ TimePeriod ä½¿ç”¨**:
   ```rust
   // å¦‚æœéœ€è¦å…¨éƒ¨æ•°æ®ï¼Œæ˜¾å¼æŒ‡å®š
   let stats = manager.get_financial_stats(TimePeriod::AllTime)?;
   ```

3. **åˆ©ç”¨æ–°çš„å­—æ®µæ¸…ç©ºåŠŸèƒ½**:
   ```rust
   // ç°åœ¨å¯ä»¥æ¸…ç©º Optional å­—æ®µ
   manager.update_student(uid, 
       StudentUpdater::new().lesson_left(None)
   )?;
   ```

4. **é…ç½®æ•°æ®ç›®å½•**:
   ```rust
   // å¯é€‰ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®
   std::env::set_var("QMX_DATA_DIR", "/your/data/path");
   ```

### ä» v1.x å‡çº§åˆ° v2.x

è¯·å‚è€ƒ `API_v2.md` ä¸­çš„è¯¦ç»†è¿ç§»æŒ‡å—ã€‚v2 API å®Œå…¨å‘åå…¼å®¹ï¼Œå¯ä»¥æ¸è¿›å¼è¿ç§»ã€‚

---

*æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒå¯¹åº”ç‰ˆæœ¬çš„ API æ–‡æ¡£ã€‚*